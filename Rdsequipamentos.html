
<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RDE — Relatório Diário de Equipamentos</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root { --paper-w: 794px; --muted: #666; }
  body {
    font-family: "Arial", Helvetica, sans-serif;
    background: #f2f4f7;
    margin: 0;
    padding: 18px;
  }
  .container { max-width: 900px; margin: 0 auto; }
  .card {
    background: #fff;
    border-radius: 10px;
    padding: 18px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  }
  h1 { font-size: 18px; margin: 0 0 12px; }
  .row { display: flex; gap: 12px; flex-wrap: wrap; }
  .col {
    flex: 1; min-width: 150px;
    display: flex; flex-direction: column;
    margin-bottom: 8px;
  }
  label { font-size: 13px; margin-bottom: 6px; color: #222; }
  input[type=text], input[type=date], select {
    padding: 8px; border: 1px solid #ddd;
    border-radius: 6px; font-size: 14px;
    background: #fff; width: 100%;
    box-sizing: border-box;
  }
  .btn {
    display: inline-block; background: #0b73d6; color: #fff;
    border: none; padding: 10px 14px;
    border-radius: 8px; font-size: 14px;
    cursor: pointer; transition: background 0.3s;
  }
  .btn:hover { background: #0959a8; }
  .btn.gray { background: #6c757d; }
  .table {
    width: 100%; border-collapse: collapse; margin-top: 12px;
    background: #f8f9fa; border-radius: 8px; overflow: hidden;
  }
  .table th, .table td {
    border: 1px solid #dcdcdc; padding: 6px;
    font-size: 12px; text-align: center;
  }
  .table th { background: #f1f3f5; }
  .actions {
    margin-top: 12px; display: flex; gap: 8px;
    flex-wrap: wrap; align-items: center; justify-content: flex-start;
  }
  .muted { color: var(--muted); font-size: 13px; }
  .rds-paper {
    width: var(--paper-w); padding: 24px; background: #fff;
    color: #111; box-sizing: border-box; font-size: 13px;
  }
  .rds-table {
    width: 100%; border-collapse: collapse; margin-top: 8px;
  }
  .rds-table td, .rds-table th {
    border: 1px solid #333; padding: 6px;
    font-size: 12px; text-align: center;
  }
  @media (max-width: 768px) {
    .row { flex-direction: column; gap: 8px; }
    .btn { width: 100%; }
    .table { display: block; overflow-x: auto; }
  }
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <h1>RDE — Relatório Diário de Equipamentos</h1>

    <div class="row">
      <div class="col"><label>Data</label><input id="rde_data" type="date"></div>
      <div class="col"><label>Hora do Documento</label><input id="rde_hora_doc" type="text" readonly></div>
    </div>

    <div class="muted">Tabela de Equipamentos</div>
    <table class="table" id="tblEquipamentos">
      <thead>
        <tr>
          <th>TAG</th>
          <th>ÁREA</th>
          <th>SIM</th>
          <th>NÃO</th>
          <th>OBSERVAÇÃO</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="actions">
      <button id="btnServidor" class="btn gray">Enviar para o Servidor</button>
<button id="btnGerarPDF" class="btn">Gerar PDF</button>
      <button id="btnExcelRDE" class="btn gray">Gerar Excel</button>
      <button id="btnLimpar" class="btn gray">Limpar</button>
    </div>
  </div>
</div>

<div id="paper" style="display:none">
  <div class="rds-paper" id="rde_report">
    <div style="display:flex;justify-content:space-between;">
      <div>
        <div style="font-size:12px">COMERCIAL ARCOS LTDA</div>
        <div style="font-size:11px;margin-top:4px">ROD BR 354, KM 474, Nº 749 - VILA CALCITA - ARCOS/MG</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">RELATÓRIO DIÁRIO DE EQUIPAMENTOS (RDE)</div>
        <div id="meta_data"></div>
        <div id="meta_hora_doc"></div>
      </div>
    </div>

    <table class="rds-table" id="rde_table_equip" style="margin-top:12px">
      <thead><tr><th>TAG</th><th>ÁREA</th><th>SIM</th><th>NÃO</th><th>OBSERVAÇÃO</th></tr></thead>
      <tbody id="rde_equip_rows"></tbody>
    </table>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

window.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  $('rde_data').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  $('rde_hora_doc').value = now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
});

const equipamentos = [
  "EMP005","EMP006","EMP007","EMP008","EMP010","EMP011","EMP012","EMP013","EMP014","EMP015",
  "EMP016","EMP017","EMP018","EMP019","EMP020","EMP021","EMP022","EMP023","EMP024","EMP025",
  "MC002","MC004","MC005","MC006",
  "PC001","PC002","PC004","PC005","PC006","PC007","PC008","PC009","PC010"
];

const tblBody = document.querySelector('#tblEquipamentos tbody');

function criarSelectArea(tagPrefix) {
  const select = document.createElement('select');
  const opcoesEMP = ["ARCOS","CAL","HIDRATAÇÃO","CARBONATO","DRS","MANUTENÇÃO","RESERVA"];
  const opcoesMC = ["CAL","CARBONATO","DRS","MANUTENÇÃO","RESERVA"];
  const opcoesPC = ["BIOMASSA","CAL","COQUE","BRITAGEM","MANUTENÇÃO","RESERVA"];
  const lista = tagPrefix.startsWith("EMP") ? opcoesEMP : tagPrefix.startsWith("MC") ? opcoesMC : opcoesPC;

  const vazio = document.createElement('option');
  vazio.textContent = "";
  vazio.value = "";
  select.appendChild(vazio);

  lista.forEach(op => {
    const o = document.createElement('option');
    o.textContent = op;
    select.appendChild(o);
  });
  return select;
}

function addRow(tag="") {
  const tr = document.createElement('tr');
  const tdTag = document.createElement('td');
  const tdArea = document.createElement('td');
  const tdSim = document.createElement('td');
  const tdNao = document.createElement('td');
  const tdObs = document.createElement('td');

  const inputTag = document.createElement('input');
  inputTag.type = 'text';
  inputTag.value = tag;
  inputTag.style.textAlign = "center";
  inputTag.addEventListener('input', () => {
    tdArea.innerHTML = "";
    tdArea.appendChild(criarSelectArea(inputTag.value.toUpperCase()));
  });

  const areaSelect = criarSelectArea(tag);
  const inputSim = document.createElement('input');
  inputSim.type = 'checkbox';
  const inputNao = document.createElement('input');
  inputNao.type = 'checkbox';
  const inputObs = document.createElement('input');
  inputObs.type = 'text';

  tdTag.appendChild(inputTag);
  tdArea.appendChild(areaSelect);
  tdSim.appendChild(inputSim);
  tdNao.appendChild(inputNao);
  tdObs.appendChild(inputObs);

  tr.append(tdTag, tdArea, tdSim, tdNao, tdObs);
  tblBody.appendChild(tr);
}

equipamentos.forEach(tag => addRow(tag));

$('btnLimpar').onclick = () => {
  tblBody.innerHTML = "";
  equipamentos.forEach(tag => addRow(tag));
};

$('btnGerarPDF').onclick = async () => {
  const { jsPDF } = window.jspdf;
  const [yyyy,mm,dd] = $('rde_data').value.split('-');
  const dataFormatada = `${dd}/${mm}/${yyyy}`;
  $('meta_data').innerText = "DATA: " + dataFormatada;
  $('meta_hora_doc').innerText = "HORA: " + $('rde_hora_doc').value;

  const tbody = $('rde_equip_rows');
  tbody.innerHTML = "";
  Array.from(tblBody.querySelectorAll('tr')).forEach(r=>{
    const inputs=r.querySelectorAll('input,select');
    const sim=inputs[2].checked?"X":"";
    const nao=inputs[3].checked?"X":"";
    const obs=inputs[4].value;
    const tr2=document.createElement('tr');
    tr2.innerHTML=`<td>${inputs[0].value}</td><td>${inputs[1].value}</td><td>${sim}</td><td>${nao}</td><td>${obs}</td>`;
    tbody.appendChild(tr2);
  });

  const wrapper=$('rde_report').cloneNode(true);
  wrapper.style.position='fixed';wrapper.style.left='-9999px';
  document.body.appendChild(wrapper);
  const canvas=await html2canvas(wrapper,{scale:2});
  const pdf=new jsPDF({unit:'pt',format:'a4'});
  const img=canvas.toDataURL('image/png');
  const w=pdf.internal.pageSize.width;
  const h=(canvas.height*w)/canvas.width;
  pdf.addImage(img,'PNG',0,0,w,h);
  pdf.save(`RDE_${dataFormatada}.pdf`);
  document.body.removeChild(wrapper);
};

$('btnExcelRDE').onclick=()=>{
  const data=$('rde_data').value.split('-').reverse().join('/');
  const linhas=Array.from(tblBody.querySelectorAll('tr')).map(r=>{
    const i=r.querySelectorAll('input,select');
    return{Data:data,TAG:i[0].value,Area:i[1].value,Sim:i[2].checked?"X":"",Nao:i[3].checked?"X":"",Observacao:i[4].value};
  });
  const ws=XLSX.utils.json_to_sheet(linhas);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'RDE');
  XLSX.writeFile(wb,`RDE_${data.replace(/\//g,'-')}.xlsx`);
  alert("✅ Excel gerado com sucesso!");
};// --- ENVIAR PARA O SERVIDOR ---
async function enviarParaServidorRDE(){
  const dataIso = $('rde_data').value;
  const data = dataIso ? dataIso.split('-').reverse().join('/') : '';
  const horaDoc = $('rde_hora_doc').value;

  const linhas = Array.from(tblBody.querySelectorAll('tr')).map(r=>{
    const i=r.querySelectorAll('input,select');
    return {
      Data:data,
      HoraDocumento:horaDoc,
      TAG:i[0].value,
      Area:i[1].value,
      Sim:i[2].checked?"X":"",
      Nao:i[3].checked?"X":"",
      Observacao:i[4].value
    };
  }).filter(l => l.TAG || l.Area || l.Sim || l.Nao || l.Observacao);

  try {
    const GET_URL = 'https://api.jsonbin.io/v3/b/6902556943b1c97be98a8193/latest';
    const PUT_URL = 'https://api.jsonbin.io/v3/b/6902556943b1c97be98a8193';
    const MASTER_KEY = '$2a$10$xR7zwFrjQCoS2LoogAgVfOhRVOufQ4AVodOT8T/m./XkGbS1UICxi';

    const resGet = await fetch(GET_URL, { headers: { 'X-Master-Key': MASTER_KEY }});
    let dadosExistentes = [];
    if(resGet.ok){
      const json = await resGet.json();
      dadosExistentes = Array.isArray(json.record) ? json.record : [];
    }

    const dadosAtualizados = [...dadosExistentes, ...linhas];

    const resPut = await fetch(PUT_URL, {
      method:'PUT',
      headers:{
        'Content-Type':'application/json',
        'X-Master-Key':MASTER_KEY,
        'X-Bin-Versioning':'false'
      },
      body:JSON.stringify(dadosAtualizados)
    });

    if(resPut.ok) alert('✅ Dados enviados para o Servidor com sucesso!');
    else alert('❌ Erro ao enviar para o Servidor.');

  } catch(err){
    alert('❌ Erro: ' + err.message);
  }
}
document.getElementById('btnServidor').onclick = enviarParaServidorRDE;
</script>
</body>
</html>
