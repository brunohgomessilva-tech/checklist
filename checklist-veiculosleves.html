<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check-List Diário — Veículos Leves</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f2f4f7;margin:0;padding:12px}
    .paper{max-width:820px;margin:0 auto;background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 12px rgba(0,0,0,0.06)}
    h1{font-size:18px;margin:0 0 8px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .col{flex:1;min-width:120px;display:flex;flex-direction:column;margin-bottom:8px}
    label{font-size:13px;margin-bottom:6px;color:#222}
    input[type=text], input[type=date], input[type=time], textarea, select {padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px;background:#fff}
    input[readonly]{background:#eee;cursor:not-allowed}
    textarea.param-desc{min-height:48px;resize:vertical}
    .items{margin-top:12px}
    .item{border:1px solid #eee;padding:10px;border-radius:6px;margin-bottom:8px;background:#fafafa}
    .item-title{font-weight:600}
    .param-desc-label{font-size:12px;color:#444;margin-top:6px;margin-bottom:4px}
    .choices{display:flex;gap:12px;align-items:center;margin-top:8px}
    .choice{display:flex;align-items:center;gap:6px}
    .obs{margin-top:8px}
    .obs input{width:100%}
    .btn{display:inline-block;background:#0b73d6;color:#fff;border:none;padding:12px 14px;border-radius:8px;font-size:15px;cursor:pointer}
    .btn-gray{background:#6c757d}
    .msg{color:green;margin-top:10px;display:none}
    .required-field {border: 2px solid #ff4444 !important;}
    @media(max-width:420px){
      .row {flex-direction: column;}
      .col {min-width: 100% !important; max-width: 100% !important;}
    }
  </style>
</head>
<body>
<div class="paper" id="paper">
  <h1>Check-List Diário — Veículos Leves</h1>

  <div class="row">
    <div class="col">
      <label for="matricula">Funcionário *</label>
      <select id="matricula" required>
        <option value="">Selecione o funcionário</option>
      </select>
    </div>
    <div class="col">
      <label for="veiculo">Veículo *</label>
      <select id="veiculo" required>
        <option value="">Selecione o veículo</option>
      </select>
    </div>
    <div class="col"><label for="data">Data</label><input id="data" type="date" readonly></div>
    <div class="col" style="max-width:120px"><label for="hora">Horário</label><input id="hora" type="time" readonly></div>
    <div class="col" style="max-width:160px"><label for="hodometro">Hodômetro (km) *</label><input id="hodometro" type="text" placeholder="12345" required></div>
  </div>

  <div class="items" id="items"></div>

  <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn" id="btnSalvarLocal">Salvar Localmente</button>
    <button class="btn" id="btnServidor">Enviar para o Servidor</button>
    <button class="btn btn-gray" id="btnExcel">Gerar Excel</button>
    <button class="btn btn-gray" id="btnGerar">Gerar PDF</button>
    <button class="btn btn-gray" id="btnInstrucoes">Como enviar pelo WhatsApp</button>
  </div>

  <div class="msg" id="msgOk">✅ Arquivo gerado com sucesso! Verifique sua pasta de downloads.</div>
  <div style="margin-top:10px;font-size:13px;color:#666">
    Os arquivos serão gerados com nome <strong>checklist_NOMECADASTRO_YYYY-MM-DD-HH-MM</strong>.
  </div>
</div>

<script>
(function(){
  const dataEl = document.getElementById('data');
  const horaEl = document.getElementById('hora');
  const hodometroEl = document.getElementById('hodometro');
  const today = new Date();
  function pad(n){return String(n).padStart(2,'0')}
  dataEl.value = today.getFullYear() + '-' + pad(today.getMonth()+1) + '-' + pad(today.getDate());
  horaEl.value = pad(today.getHours()) + ':' + pad(today.getMinutes());

  const funcionarios = [
    {codigo:"80096", nome:"AILTON RODRIGO COUTINHO"},
    {codigo:"80229", nome:"BEATRIZ ESTELA ELIAS DA SILVA"},
    {codigo:"80216", nome:"BRENO CALACIO DOS REIS"},
    {codigo:"80150", nome:"BRUNA DA CUNHA ALVES"},
    {codigo:"80227", nome:"BRUNO HENRIK GOMES SILVA"},
    {codigo:"80230", nome:"DAIANY MINUCCI GARCIA"},
    {codigo:"90001", nome:"GENTIL JOSÉ DE OLIVEIRA"},
    {codigo:"80240", nome:"GILSON GERALDO MINUCCI GARCIA SILVA"},
    {codigo:"80116", nome:"GUSTAVO TEIXEIRA DA SILVA"},
    {codigo:"02003", nome:"JOÃO VICTOR SANTOS"},
    {codigo:"80188", nome:"JOÃO VITOR ARRUDA"},
    {codigo:"80215", nome:"JOÃO PEDRO ROCHA DOMINGOS"},
    {codigo:"80224", nome:"JOSE CARLOS RAMOS RODRIGUES"},
    {codigo:"80119", nome:"JOSE WALTER DE OLIVEIRA"},
    {codigo:"80065", nome:"JOYCE RAFAELA LOPES DA SILVA"},
    {codigo:"80219", nome:"JORDANYA ALVES PEREIRA SANTOS"},
    {codigo:"80221", nome:"JULIA FERNANDES DA SILVA"},
    {codigo:"02019", nome:"JUNIOR WESLEY MESSIAS"},
    {codigo:"80184", nome:"LARICE EDUARDA MARTINS"},
    {codigo:"91002", nome:"LIVIA MENEZES OLIVEIRA"},
    {codigo:"80231", nome:"LUIS ANTONIO LOPES VELOSO"},
    {codigo:"91003", nome:"NICOMEDES AUGUSTO DE OLEIVEIRA"},
    {codigo:"80060", nome:"POLIANA OLIVEIRA"},
    {codigo:"80175", nome:"REINALDO DOS SANTOS VALADÃO"},
    {codigo:"80225", nome:"RICARDO AUGUSTO DOS SANTOS"},
    {codigo:"80021", nome:"RINALDO CESAR PEREIRA"},
    {codigo:"80170", nome:"RODOLFO CARDOSO TEIXEIRA"},
    {codigo:"01541", nome:"SILVIO AUGUSTO DE ASSIS"},
    {codigo:"80222", nome:"TIAGO SILVA DE OLIVEIRA"},
    {codigo:"80101", nome:"TIAGO LEONE RAMOS DA SILVA"},
    {codigo:"80139", nome:"VANDERLEI BORGES"},
    {codigo:"80226", nome:"VIVIANE DE FIGUEIREDO TEIXEIRA"}
  ];

  const selectFuncionario = document.getElementById('matricula');
  funcionarios.forEach(f => {
    const option = document.createElement('option');
    option.value = f.codigo;
    option.textContent = `${f.codigo} - ${f.nome}`;
    selectFuncionario.appendChild(option);
  });

  const veiculos = [
    {codigo:"CAM04", descricao:"F-1000 SS 1993 - BIS-6668"},
    {codigo:"CAM05", descricao:"STRADA TREKING CD 2012 - OMC-0835"},
    {codigo:"CAM11", descricao:"SAVEIRO TROPPER 2012 - HNB-8162"},
    {codigo:"CAM12", descricao:"MONTANA LS 2013 - BRANCA - OQV-3D95"},
    {codigo:"CAR01", descricao:"UNO FIRE 2006 - GSZ-1347"},
    {codigo:"CAR07", descricao:"FIAT/MOBI - QWY-4310"},
    {codigo:"CAR11", descricao:"MONTANA 2017 - PRATA - PYC-9B75"},
    {codigo:"CAR12", descricao:"PALIO FIRE WAY -FIAT - 2015 - BRANCA - PWU-2G17"},
    {codigo:"CAR13", descricao:"FIORINO - SYB-6B40"},
    {codigo:"CAR14", descricao:"FIORINO - SYB-5J50"},
    {codigo:"CAR15", descricao:"ARGO DRI 1.0 FLEX - TEH-9I88"}
  ];

  const selectVeiculo = document.getElementById('veiculo');
  veiculos.forEach(v => {
    const option = document.createElement('option');
    option.value = v.codigo;
    option.textContent = `${v.codigo} - ${v.descricao}`;
    selectVeiculo.appendChild(option);
  });

  const itens = [
    'Condição geral','Condições dos pneus e rodas','Água do radiador','Óleo do motor','Tanque de combustível','Extintor de incêndio',
    'Luzes e parte elétrica em geral','Buzina','Freios em geral','Bandeirola','Triângulo / macaco / chave roda',
    'Retrovisor / janelas / para-brisa e vidros em geral','Cinto de segurança','Sinalizações','Giroflex','Documentação do Veículo'
  ];

  const descs = [
    'Sem vazamentos, sem peças ou partes soltas, bancos em condições de assentar, portas fechando, direção alinhada, etc.',
    'Calibrados, sem lesões, rasgos e trincas, aparência normal, bom estado conservação, step preso ao suporte. Rodas com todos os parafusos',
    'Sempre completo de acordo com o nível indicado.',
    'Acusando o nível normal na vareta, sendo trocado na data correta, de acordo com o manual de orientação e manutenção do veículo.',
    'Sem vazamentos/ possuir combustível suficiente.',
    'Fixo no suporte, lacrado e carregado (manômetro indicando a faixa verde), dentro do prazo de validade. CLASSE ABC',
    'Funcionamento perfeito dos faróis e sinalizador de setas, alarme sonoro de ré, limpador de para-brisa, luz freio, faroletes, outros, etc...',
    'Deve estar funcionando.',
    'Freando com eficiência. Freio de estacionamento regulado e funcionando em perfeito estado.',
    'Deve possuir para acesso na área da mina e britagem.',
    'Funcionando, testados e em perfeito estado, junto ao veículo.',
    'Regulado, sem trincas e em perfeito estado de funcionamento',
    'Funcionando e em perfeito estado para todos ocupantes',
    'Faixas refletivas conforme padrão. Placas legíveis',
    'Para acesso na área da mina e britagem durante a noite, deve estar funcionando.',
    'Ipva, seguro, emplacamento, credenciamento interno dentro da validade.'
  ];

  const itensComNaoSeAplica = [6,10,14,15];
  const itemsContainer = document.getElementById('items');

  itens.forEach((t,i)=>{
    const n = i+1;
    const div = document.createElement('div');
    div.className = 'item';
    div.setAttribute('data-num',n);

    let choicesHTML = `
      <label class="choice"><input type="radio" name="choice_${n}" value="conforme"> Conforme</label>
      <label class="choice"><input type="radio" name="choice_${n}" value="medio"> Médio</label>
      <label class="choice"><input type="radio" name="choice_${n}" value="fora"> Fora</label>
    `;
    if(itensComNaoSeAplica.includes(n)) {
      choicesHTML += `<label class="choice"><input type="radio" name="choice_${n}" value="nao_se_aplica" checked> Não se aplica</label>`;
    }

    div.innerHTML = `
      <div class="item-title">${n}. ${t}</div>
      <div class="param-desc-label">Descrição do parâmetro</div>
      <textarea class="param-desc">${descs[i]}</textarea>
      <div class="choices">${choicesHTML}</div>
      <div class="obs"><label>Observação</label><input type="text" class="obs_input" placeholder="Comentário (opcional)"></div>
    `;
    itemsContainer.appendChild(div);
  });

  // Função para validar campos obrigatórios
  function validarCamposObrigatorios() {
    let valido = true;
    
    // Remover estilos de erro anteriores
    selectFuncionario.classList.remove('required-field');
    selectVeiculo.classList.remove('required-field');
    hodometroEl.classList.remove('required-field');
    
    // Validar funcionário
    if (!selectFuncionario.value) {
      selectFuncionario.classList.add('required-field');
      valido = false;
    }
    
    // Validar veículo
    if (!selectVeiculo.value) {
      selectVeiculo.classList.add('required-field');
      valido = false;
    }
    
    // Validar hodômetro
    if (!hodometroEl.value.trim()) {
      hodometroEl.classList.add('required-field');
      valido = false;
    }
    
    return valido;
  }

  function coletarDados(){
    return Array.from(document.querySelectorAll('#items .item'))
      .map(it => ({
        num: it.getAttribute('data-num'),
        title: it.querySelector('.item-title').textContent.replace(/^\d+\.\s*/,'').trim(),
        desc: it.querySelector('.param-desc').value.trim(),
        status: Array.from(it.querySelectorAll('input[type=radio]')).find(r=>r.checked)?.value || '',
        obs: it.querySelector('.obs_input').value.trim()
      }))
      // FILTRAR: manter apenas itens com status "medio" ou "fora"
      .filter(item => item.status === 'medio' || item.status === 'fora');
  }

  function limparNomeArquivo(nome){return nome.replace(/[^a-z0-9_-]/gi, '_');}
  function msgOK(){const m = document.getElementById('msgOk'); m.style.display = 'block'; setTimeout(()=>m.style.display='none',6000);}

  async function gerarPDFsalvar(){
    if (!validarCamposObrigatorios()) {
      alert('❌ Por favor, preencha todos os campos obrigatórios antes de gerar o PDF.');
      return;
    }
    
    const dados = {data:dataEl.value, hora:horaEl.value, matricula:selectFuncionario.value.trim(), veiculo:selectVeiculo.value.trim(), hodometro:hodometroEl.value.trim(), items:coletarDados()};
    const nomeFuncionarioCompleto = funcionarios.find(f => f.codigo===dados.matricula)?.nome || 'sem_nome';
    const nomeFuncionario = limparNomeArquivo(nomeFuncionarioCompleto);
    const dataArquivo = `${dados.data}-${dados.hora.replace(':','-')}`;
    const nomeArquivo = `checklist_${nomeFuncionario}_${dataArquivo}.pdf`;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit:'pt', format:'a4', orientation:'portrait' });
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    let yOffset = 40;
    const lineHeight = 16;
    const margin = 40;

    pdf.setFontSize(14);
    pdf.text(`Check-List Diário — Veículos Leves`, margin, yOffset); yOffset += lineHeight + 4;
    pdf.setFontSize(11);
    pdf.text(`Data: ${dados.data.split('-').reverse().join('/')}   Horário: ${dados.hora || '-'}`, margin, yOffset);
    yOffset += lineHeight;
    pdf.text(`Funcionário: ${nomeFuncionarioCompleto || '-'}`, margin, yOffset); yOffset += lineHeight;
    pdf.text(`Veículo: ${dados.veiculo || '-'}`, margin, yOffset); yOffset += lineHeight;
    pdf.text(`Hodômetro: ${dados.hodometro || '-'}`, margin, yOffset); yOffset += lineHeight + 8;
    pdf.line(margin, yOffset, pageWidth-margin, yOffset); yOffset += 12;

    // Adicionar nota sobre itens filtrados
    pdf.setFontSize(10);
    pdf.text('Nota: Apenas itens com status "Médio" ou "Fora" são incluídos neste relatório.', margin, yOffset);
    yOffset += lineHeight + 8;

    dados.items.forEach(it=>{
      if(yOffset + 80 > pageHeight){ pdf.addPage(); yOffset = margin; }
      pdf.setFontSize(12); pdf.setFont(undefined,'bold');
      pdf.text(`${it.num}. ${it.title}`, margin, yOffset); yOffset += lineHeight;
      pdf.setFontSize(11); pdf.setFont(undefined,'normal');
      const descLines = pdf.splitTextToSize(it.desc, pageWidth - 2*margin);
      pdf.text(descLines, margin, yOffset); yOffset += descLines.length*lineHeight;
      pdf.text(`Status: ${it.status || '-'}`, margin, yOffset); yOffset += lineHeight;
      const obsLines = pdf.splitTextToSize(`Observação: ${it.obs || '-'}`, pageWidth - 2*margin);
      pdf.text(obsLines, margin, yOffset); yOffset += obsLines.length*lineHeight + 8;
    });

    pdf.save(nomeArquivo);
    msgOK();
  }

  function gerarExcel(){
    if (!validarCamposObrigatorios()) {
      alert('❌ Por favor, preencha todos os campos obrigatórios antes de gerar o Excel.');
      return;
    }
    
    const dados = coletarDados();
    const matricula = selectFuncionario.value.trim();
    const veiculo = selectVeiculo.value.trim();
    const nomeFuncionario = limparNomeArquivo(funcionarios.find(f => f.codigo===matricula)?.nome || 'sem_nome');
    const dataArquivo = `${dataEl.value}-${horaEl.value.replace(':','-')}`;
    const nomeArquivo = `checklist_${nomeFuncionario}_${dataArquivo}.xlsx`;

    // Se não houver itens, cria uma linha vazia com apenas os dados do cabeçalho
    const linhas = dados.length > 0 
      ? dados.map(it => ({
          Data: dataEl.value.split('-').reverse().join('/'),
          Horario: horaEl.value,
          Funcionario: matricula,
          Veiculo: veiculo,
          Hodometro: hodometroEl.value.trim(),
          Numero: it.num,
          Item: it.title,
          Descricao: it.desc,
          Status: it.status,
          Observacao: it.obs
        }))
      : [{
          Data: dataEl.value.split('-').reverse().join('/'),
          Horario: horaEl.value,
          Funcionario: matricula,
          Veiculo: veiculo,
          Hodometro: hodometroEl.value.trim(),
          Numero: '',
          Item: '',
          Descricao: '',
          Status: '',
          Observacao: 'Nenhum item com status "Médio" ou "Fora"'
        }];

    const ws = XLSX.utils.json_to_sheet(linhas);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Checklist');
    XLSX.writeFile(wb, nomeArquivo);
    msgOK();
  }

  function salvarLocalmente(){
    if (!validarCamposObrigatorios()) {
      alert('❌ Por favor, preencha todos os campos obrigatórios antes de salvar localmente.');
      return;
    }
    
    const dadosLocal = {data:dataEl.value,hora:horaEl.value,matricula:selectFuncionario.value,veiculo:selectVeiculo.value,hodometro:hodometroEl.value.trim(),items:coletarDados()};
    localStorage.setItem('checklist_veiculos', JSON.stringify(dadosLocal));
    alert('✅ Checklist salvo localmente!');
  }

  async function enviarParaServidor(){
    if (!validarCamposObrigatorios()) {
      alert('❌ Por favor, preencha todos os campos obrigatórios antes de enviar para o servidor.');
      return;
    }
    
    const dados = coletarDados();
    
    // Se não houver itens, cria uma linha vazia com apenas os dados do cabeçalho
    const dadosNovo = dados.length > 0 
      ? dados.map(it => ({
          Data: dataEl.value.split('-').reverse().join('/'),
          Horario: horaEl.value,
          Funcionario: selectFuncionario.value.trim(),
          Veiculo: selectVeiculo.value.trim(),
          Hodometro: hodometroEl.value.trim(),
          Numero: it.num,
          Item: it.title,
          Descricao: it.desc,
          Status: it.status,
          Observacao: it.obs
        }))
      : [{
          Data: dataEl.value.split('-').reverse().join('/'),
          Horario: horaEl.value,
          Funcionario: selectFuncionario.value.trim(),
          Veiculo: selectVeiculo.value.trim(),
          Hodometro: hodometroEl.value.trim(),
          Numero: '',
          Item: '',
          Descricao: '',
          Status: '',
          Observacao: 'Nenhum item com status "Médio" ou "Fora"'
        }];

    try {
      const resGet = await fetch('https://api.jsonbin.io/v3/b/69023644ae596e708f35f300/latest', {
        method:'GET',
        headers:{'X-Master-Key':'$2a$10$xR7zwFrjQCoS2LoogAgVfOhRVOufQ4AVodOT8T/m./XkGbS1UICxi'}
      });

      let dadosExistentes = [];
      if(resGet.ok){
        const json = await resGet.json();
        dadosExistentes = Array.isArray(json.record)? json.record : [];
      }

      const dadosAtualizados = [...dadosExistentes,...dadosNovo];

      const resPut = await fetch('https://api.jsonbin.io/v3/b/69023644ae596e708f35f300',{
        method:'PUT',
        headers:{
          'Content-Type':'application/json',
          'X-Master-Key':'$2a$10$xR7zwFrjQCoS2LoogAgVfOhRVOufQ4AVodOT8T/m./XkGbS1UICxi',
          'X-Bin-Versioning':'false'
        },
        body:JSON.stringify(dadosAtualizados)
      });

      if(resPut.ok){
        alert('✅ Checklist enviado para o Servidor com sucesso!');
        localStorage.removeItem('checklist_veiculos');
        window.location.reload();
      } else {
        alert('❌ Erro ao atualizar o Servidor: '+resPut.statusText);
      }
    } catch(err){
      alert('❌ Erro na requisição: '+err.message);
    }
  }

  const dadosSalvos = localStorage.getItem('checklist_veiculos');
  if(dadosSalvos){
    try{
      const obj = JSON.parse(dadosSalvos);
      selectFuncionario.value = obj.matricula || '';
      selectVeiculo.value = obj.veiculo || '';
      hodometroEl.value = obj.hodometro || '';
      if(obj.items && Array.isArray(obj.items)){
        obj.items.forEach(it=>{
          const el = document.querySelector(`.item[data-num="${it.num}"]`);
          if(el){
            el.querySelector('.param-desc').value = it.desc || '';
            const radio = Array.from(el.querySelectorAll('input[type=radio]')).find(r=>r.value===it.status);
            if(radio) radio.checked = true;
            el.querySelector('.obs_input').value = it.obs || '';
          }
        });
      }
    } catch(e){}
  }

  window.addEventListener('online', ()=>{
    const dadosSalvos = localStorage.getItem('checklist_veiculos');
    if(dadosSalvos){
      enviarParaServidor();
    }
  });

  document.getElementById('btnGerar').onclick = gerarPDFsalvar;
  document.getElementById('btnExcel').onclick = gerarExcel;
  document.getElementById('btnSalvarLocal').onclick = salvarLocalmente;
  document.getElementById('btnServidor').onclick = enviarParaServidor;
  document.getElementById('btnInstrucoes').onclick = ()=>alert('Após gerar o PDF ou Excel, abra o WhatsApp e envie o arquivo como anexo para o contato desejado.');
})();
</script>
</body>
</html>

